name: Build and run

on:
  push:
    branches: [ "main" ]

jobs:
  boot-node:
    runs-on: [ "boot-node" ]
    outputs:
      CONNECTION_STRING: ${{steps.host-selector.outputs.CONNECTION_STRING}}
    steps:
    - name: Checkout code
      uses: actions/checkout@v2
    - name: Copy binary & restart service
      run: |
        sudo systemctl stop masa-oracle.service
        go mod tidy
        go build -v -o masa-node ./cmd/masa-node
        cp ./cmd/masa-node/main.go /home/mykhaylo/masa-oracle-main/cmd/masa-node/main.go
        sudo systemctl daemon-reload
        sudo systemctl restart masa-oracle.service
    - name: Get host address
      id: host-selector
      run: |
        CONNECTION_STRING=$(systemctl -l --no-pager status masa-oracle.service | grep 'libp2p host address:' | awk '{print $NF}')
        while [ -z "$CONNECTION_STRING" ]
          do
            CONNECTION_STRING=$(sudo systemctl -l --no-pager status masa-oracle.service | grep 'libp2p host address:' | awk '{print $NF}')
          done
        echo $CONNECTION_STRING
        echo "CONNECTION_STRING=$CONNECTION_STRING" >> "$GITHUB_OUTPUT"

  node:
    needs: boot-node
    runs-on: [ "node" ]
    steps:
    - name: Checkout code
      uses: actions/checkout@v2
    - name: Fetch dependencies & build app
      run: |
        go mod tidy
        go build -v -o masa-node ./cmd/masa-node
    - name: Copy binary & restart service
      run: |
        sudo systemctl stop masa-oracle.service
        cp ./cmd/masa-node/main.go /home/mykhaylo/masa-oracle-main/cmd/masa-node/main.go
        echo "CONNECTION_STRING=${{needs.boot-node.outputs.CONNECTION_STRING}}" > /home/mykhaylo/masa-oracle-main/cmd/masa-node/.argconf
        sudo systemctl daemon-reload
        sudo systemctl start masa-oracle.service
